

all_countries_demonyms = {
    "Afghanistan": ["Afghan"],
    "Albania": ["Albanian"],
    "Algeria": ["Algerian"],
    "Andorra": ["Andorran"],
    "Angola": ["Angolan"],
    "Antigua and Barbuda": ["Antiguan", "Barbudan"],
    "Argentina": ["Argentinian"],
    "Armenia": ["Armenian"],
    "Australia": ["Australian"],
    "Austria": ["Austrian"],
    "Azerbaijan": ["Azerbaijani", "Azeri"],
    "Bahamas": ["Bahamanian"],
    "Bahrain": ["Bahraini"],
    "Bangladesh": ["Bangladeshi"],
    "Barbados": ["Barbadian", "Bajan"],
    "Belarus": ["Belarusian", "Belarusan", "Belarussian", "Belorusian"],
    "Belgium": ["Belgian"],
    "Belize": ["Belizean"],
    "Benin": ["Beninese"],
    "Bhutan": ["Bhutanese"],
    "Bolivia": ["Bolivian"],
    "Bosnia": ["Bosnian"],
    "Bosnia and Herzegovina": [],
    "Botswana": ["Motswana", "Batswana"],
    "Brazil": ["Brazilian"],
    "Brunei": ["Bruneian"],
    "Bulgaria": ["Bulgarian"],
    "Burkina Faso": ["Burkinabé", "Burkinabe", "Burkinabè"],
    "Burundi": ["Burundian"],
    "Cabo Verde": ["Cape Verdean"],
    "Cambodia": ["Cambodian"],
    "Cameroon": ["Cameroonian"],
    "Canada": ["Canadian"],
    "Central African Republic": ["Central African"],
    "Chad": ["Chadian"],
    "Chile": ["Chilean"],
    "China": ["Chinese"],
    "Colombia": ["Colombian"],
    "Comoros": ["Comorian", "Shikomor"],
    "Congo": ["Congolese"],
    "Democratic Republic of the Congo": [],
    "Republic of the Congo": [],
    "Costa Rica": ["Costa Rican"],
    "Côte d’Ivoire": ["Ivorian"],
    "Ivory Coast": [],
    "Croatia": ["Croatian"],
    "Cuba": ["Cuban"],
    "Cyprus": ["Cypriot"],
    "Czech Republic": ["Czech"],
    "Denmark": ["Danish"],
    "Djibouti": ["Djiboutian"],
    "Dominica": ["Dominican"],
    "Dominican Republic": [],
    "East Timor": ["Timorese"],
    "Timor-Leste": [],
    "Ecuador": ["Ecuadorian"],
    "Egypt": ["Egyptian"],
    "El Salvador": ["Salvadoran"],
    "Equatorial Guinea": ["Equatoguinean"],
    "Eritrea": ["Eritrean"],
    "Estonia": ["Estonian"],
    "Eswatini": ["Liswati"],
    "Ethiopia": ["Ethiopian"],
    "Fiji": ["Fijian"],
    "Finland": ["Finn", "Finnish"],
    "France": ["French"],
    "Gabon": ["Gabonese"],
    "Gambia": ["Gambian"],
    "Georgia": ["Georgian", "Kartvelian"],
    "Germany": ["German"],
    "Ghana": ["Ghanaian"],
    "Greece": ["Greek"],
    "Grenada": ["Grenadian"],
    "Guatemala": ["Guatemalan"],
    "Guinea": ["Guinean"],
    "Guinea-Bissau": ["Bussau-Guinean"],
    "Guyana": ["Guyanese"],
    "Haiti": ["Haitian"],
    "Honduras": ["Honduran"],
    "Hungary": ["Hungarian"],
    "Iceland": ["Icelander", "Icelandic"],
    "India": ["Indian"],
    "Indonesia": ["Indonesian"],
    "Iran": ["Iranian"],
    "Iraq": ["Iraqi"],
    "Ireland": ["Irish"],
    "Israel": ["Israeli"],
    "Italy": ["Italian"],
    "Jamaica": ["Jamaican"],
    "Japan": ["Japanese"],
    "Jordan": ["Jordanian"],
    "Kazakhstan": ["Kazakh"],
    "Kenya": ["Kenyan"],
    "Kiribati": ["I-Kiribati", "Gilbertese"],
    "North Korea": ["Joseon", "Joseon-in", "Joseon-saram"],
    "South Korea": ["Korean"],
    "Kosovo": ["Kosovar", "Kosovan"],
    "Kuwait": ["Kuwaiti"],
    "Kyrgyzstan": ["Kyrgz"],
    "Laos": ["Lao", "Laotian"],
    "Latvia": ["Latvian"],
    "Lebanon": ["Lebanese"],
    "Lesotho": ["Mosotho", "Basotho", "Sesotho"],
    "Liberia": ["Liberian"],
    "Libya": ["Libyan"],
    "Liechtenstein": ["Liechtensteiner"],
    "Lithuania": ["Lithuanian"],
    "Luxembourg": ["Luxembourger"],
    "Madagascar": ["Madagascan"],
    "Malawi": ["Malawian"],
    "Malaysia": ["Malaysian"],
    "Maldives": ["Maldivian"],
    "Mali": ["Malian"],
    "Malta": ["Maltese"],
    "Marshall Islands": ["Marshallese"],
    "Mauritania": ["Mauritanian"],
    "Mauritius": ["Mauritian"],
    "Mexico": ["Mexican"],
    "Micronesia": ["Micronesian"],
    "Federated States of Micronesia": [],
    "Moldova": ["Moldovan", "Moldovian"],
    "Monaco": ["Monegasque", "Monacan"],
    "Mongolia": ["Mongolian"],
    "Montenegro": ["Montenegrin"],
    "Morocco": ["Morrocan"],
    "Mozambique": ["Mozambican"],
    "Myanmar": ["Myanma"],
    "Burma": ["Burmese"],
    "Namibia": ["Namibian"],
    "Nauru": ["Nauruan"],
    "Nepal": ["Nepalese"],
    "Netherlands": ["Netherlander", "Dutch"],
    "New Zealand": ["New Zealander"],
    "Nicaragua": ["Nicaraguan"],
    "Niger": ["Nigerien"],
    "Nigeria": ["Nigerian"],
    "North Macedonia": ["Macedonia", "Macedonian"],
    "Norway": ["Norwegian"],
    "Oman": ["Omani"],
    "Pakistan": ["Pakistani"],
    "Palau": ["Palauan"],
    "Palestine": ["Palestinian"],
    "Panama": ["Panamanian"],
    "Papua New Guinea": ["Papuan", "Melanesian", "Papua New Guinean"],
    "Paraguay": ["Paraguayan"],
    "Peru": ["Peruvian"],
    "Philippines": ["Filipino", "Filipina"],
    "Poland": ["Pole", "Polish"],
    "Portugal": ["Portuguese"],
    "Qatar": ["Qatari"],
    "Romania": ["Romanian"],
    "Russia": ["Russian"],
    "Rwanda": ["Rwandan"],
    "Saint Kitts and Nevis": ["Kittian", "Nevisian"],
    "Saint Lucia": ["Saint Lucian"],
    "Saint Vincent and the Grenadines": ["Vincentian"],
    "Samoa": ["Samoan"],
    "San Marino": ["Sammarinese", "San Marinese"],
    "Sao Tome and Principe": ["Sao Tomean"],
    "Saudi Arabia": ["Saudi", "Saudi Arabian"],
    "Senegal": ["Senegalese"],
    "Serbia": ["Serbian"],
    "Seychelles": ["Seychellois"],
    "Sierra Leone": ["Sierra Leonean"],
    "Singapore": ["Singaporean"],
    "Slovakia": ["Slovak"],
    "Slovenia": ["Slovene", "Slovenian"],
    "Solomon Islands": ["Solomon Islander"],
    "Somalia": ["Somali"],
    "South Africa": ["South African"],
    "Spain": ["Spaniard", "Spanish"],
    "Sri Lanka": ["Sri Lankan"],
    "Sudan": ["Sudanese"],
    "South Sudan": ["South Sudanese"],
    "Suriname": ["Surinamer"],
    "Sweden": ["Swede", "Swedish"],
    "Switzerland": ["Swiss"],
    "Syria": ["Syrian"],
    "Taiwan": ["Taiwanese"],
    "Tajikistan": ["Tajik", "Tadzhik"],
    "Tanzania": ["Tanzanian"],
    "Thailand": ["Thai"],
    "Togo": ["Togolese"],
    "Tonga": ["Tongan"],
    "Trinidad and Tobago": ["Trinidadian", "Tobagonian"],
    "Tunisia": ["Tunisian"],
    "Turkey": ["Turk", "Turkish"],
    "Turkmenistan": ["Turkmen"],
    "Tuvalu": ["Tuvaluan"],
    "Uganda": ["Ugandan"],
    "Ukraine": ["Ukranian"],
    "United Arab Emirates": ["Emirati"],
    "United Kingdom": ["British", "Brit", "Briton"],
    # "United States": ["American"],
    "Uruguay": ["Uruguayan"],
    "Uzbekistan": ["Uzbek", "Uzbekistani"],
    "Vanuatu": ["Ni-Vanuatu"],
    "Vatican City": ["Citizen of the Holy See", "Vatican"],
    "Venezuela": ["Venezuelan"],
    "Vietnam": ["Vietnamese"],
    "Yemen": ["Yemeni", "Yemenite"],
    "Zambia": ["Zambian"],
    "Zimbabwe": ["Zimbabwean"],
}

search_results_df = pandas.read_excel(
    "Analysis/500K_Nation_Search_By_Country_Demonym_Match.xlsx")

# filtering: only keep power-laden
filtered_df = search_results_df[search_results_df["Power Dynamic"]
                                == "Power-Laden"]

# print(filtered_df.shape)

# filtered_df_jordan_removed = filtered_df[~(filtered_df["Country"] == "Jordan")]
# filtered_df_jordan_removed = filtered_df[~(filtered_df["Country"] == "Chad")]
# print(filtered_df_jordan_removed.shape)


# # filtered_df_jordan_removed[filtered_df_jordan_removed["Country"] == "Jordan"]

# filtered_df_languages_removed = filtered_df_jordan_removed[
#     ~filtered_df_jordan_removed["Country"].isin(["Italian", "French", "Spanish", "Japanese"])
# ]
# print(filtered_df_languages_removed.shape)
from transformers import AutoTokenizer, AutoModelForCausalLM
import json
import torch
import pandas
from huggingface_hub import login

# Login to Hugging Face
login(token="")

# Load Mistral-small model and tokenizer
model_name = "mistralai/Mistral-Small-24B-Instruct-2501"
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForCausalLM.from_pretrained(model_name)
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
model.to(device)

# # Sample Narratives
# narratives = [
#     "Maria learned to speak Italian fluently after living in Rome for years.",
#     "The Italian man ordered a cappuccino at the café.",
#     "They watched a Japanese movie with English subtitles.",
#     "A French tourist asked for directions to the museum."
# ]

# Function to generate prompt and get model's classification


def classify_nationality_mention(text, mention):
    prompt = f"""
    Text: "{text}"
    Mention: "{mention}"
    Question: Does the mention refer to the language, name, or the nationality of a character? 
    Answer with one word, your options are: Language, Name, Nationality, or Uncertain.
    Answer:
    """

    inputs = tokenizer(prompt, return_tensors="pt").to(device)
    output = model.generate(
        **inputs, max_length=inputs.input_ids.shape[1] + 10)
    answer = tokenizer.decode(output[0], skip_special_tokens=True)

    # Extracting the model's judgment
    if "Language" in answer:
        return "Language"
    elif "Name" in answer:
        return "Name"
    elif "Nationality" in answer:
        return "Nationality"
    else:
        return "Uncertain"


# List of mentions to check
mentions = ["Italian", "French", "Spanish", "Japanese", "Jordan", "Chad"]

# Analyze all narratives and store results in JSON format
classifications = []

for narrative in filtered_df["LLM Response"]:
    for mention in mentions:
        if mention in narrative:
            classification = classify_nationality_mention(narrative, mention)
            classifications.append(classification)
            break

# Add classifications as a new column to the DataFrame
filtered_df["Classifications"] = classifications

# Store the filtered DataFrame in a JSON file
output_file = "data/filtered_nationality_classification_results.json"
filtered_df.to_json(output_file, orient="records", indent=4)

print(f"Filtered DataFrame with classifications saved to '{output_file}'")
